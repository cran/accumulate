<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Mark P.J. van der Loo" />
  <title>Introduction to accumulate</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <style type="text/css">
body {
max-width: 50rem;
margin-left: auto;
margin-right: auto;
font-family: system-ui;
color: lightgray;
background: #555555;
}
p, li {
text-align: justify;
}
pre {
background: #444;
padding: 0.5rem;
}
h1, h2, h3, h4, h5 {
color: orange;
font-weight: bold;
}
h4, h5 {
color: inherit;
}
h2 {
margin-top: 3rem;
}
a {
color: orange;
}
a:hover {
color: lightblue;
}
pre code {
color: white;
background: inherit;
padding: 0;
}
code {
color: #e5c892;
background: #444;
padding: 0.2rem;
}

p.author {
font-weight : bold;
color: orange;
}

code {
color : lightgray;
}
code span.op {
color: #cccccc;
}
code span.kw, code span.cf {
color: #30bd58;
}
code span.st {
color: #76a9db; }
code span.dv, code span.ot, code span.fl{
color: #7fd0a8; }
code span.dt, code span.er {
color: #ee8c70; }
</style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Introduction to <code>accumulate</code></h1>
<p class="author">Mark P.J. van der Loo</p>
</header>
<!--
%\VignetteEngine{simplermarkdown::mdweave_to_html}
%\VignetteIndexEntry{Introduction to accumulate}
-->
<p>Package version 0.9.0.</p>
<p>Use <code>citation(&#39;accumulate&#39;)</code> to cite the package.</p>
<h2 id="introduction">Introduction</h2>
<p><code>Accumulate</code> is a package for grouped aggregation, where the groups can be dynamically collapsed into larger groups. When this collapsing takes place and how collapsing takes place is user-defined.</p>
<h2 id="installation">Installation</h2>
<p>The latest CRAN release can be installed as follows.</p>
<pre><code>install.packages(&quot;accumulate&quot;)</code></pre>
<p>Next, the package can be loaded. You can use <code>packageVersion</code> (from base R) to check which version you have installed.</p>
<div class="sourceCode" id="load_package"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="load_package-1" title="1"><span class="op">&gt;</span><span class="st"> </span><span class="kw">library</span>(accumulate)</a>
<a class="sourceLine" id="load_package-2" title="2"></a>
<a class="sourceLine" id="load_package-3" title="3"><span class="op">&gt;</span><span class="st"> </span><span class="kw">packageVersion</span>(<span class="st">&quot;accumulate&quot;</span>)</a>
<a class="sourceLine" id="load_package-4" title="4">[<span class="dv">1</span>] ‘<span class="dv">0</span>.<span class="fl">9.0</span>’</a></code></pre></div>
<h2 id="a-first-example">A first example</h2>
<p>We will use a built-in dataset as example.</p>
<div class="sourceCode" id="loading_data"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="loading_data-1" title="1"><span class="op">&gt;</span><span class="st"> </span><span class="kw">data</span>(producers)</a>
<a class="sourceLine" id="loading_data-2" title="2"></a>
<a class="sourceLine" id="loading_data-3" title="3"><span class="op">&gt;</span><span class="st"> </span><span class="kw">head</span>(producers)</a>
<a class="sourceLine" id="loading_data-4" title="4">   sbi size industrial trade other other_income  total</a>
<a class="sourceLine" id="loading_data-5" title="5"><span class="dv">1</span> <span class="dv">3410</span>    <span class="dv">8</span>     <span class="dv">151722</span>  <span class="dv">2135</span>     <span class="dv">0</span>        <span class="dv">-1775</span> <span class="dv">152082</span></a>
<a class="sourceLine" id="loading_data-6" title="6"><span class="dv">2</span> <span class="dv">2840</span>    <span class="dv">7</span>      <span class="dv">50816</span>    <span class="ot">NA</span>   <span class="dv">158</span>          <span class="dv">949</span>  <span class="dv">59876</span></a>
<a class="sourceLine" id="loading_data-7" title="7"><span class="dv">3</span> <span class="dv">2752</span>    <span class="dv">5</span>       <span class="dv">4336</span>    <span class="ot">NA</span>     <span class="dv">0</span>           <span class="dv">36</span>   <span class="dv">4959</span></a>
<a class="sourceLine" id="loading_data-8" title="8"><span class="dv">4</span> <span class="dv">3120</span>    <span class="dv">6</span>      <span class="dv">18508</span>    <span class="ot">NA</span>     <span class="dv">0</span>           <span class="dv">80</span>  <span class="dv">20682</span></a>
<a class="sourceLine" id="loading_data-9" title="9"><span class="dv">5</span> <span class="dv">2524</span>    <span class="dv">7</span>      <span class="dv">21071</span>     <span class="dv">0</span>     <span class="dv">0</span>          <span class="dv">442</span>  <span class="dv">21513</span></a>
<a class="sourceLine" id="loading_data-10" title="10"><span class="dv">6</span> <span class="dv">3410</span>    <span class="dv">6</span>      <span class="dv">24220</span>  <span class="dv">1069</span>     <span class="dv">0</span>          <span class="dv">239</span>  <span class="dv">25528</span></a></code></pre></div>
<p>This synthetic dataset contains information on various sources of turnover from producers, that are labeled with an economic activity classification (<code>sbi</code>) and a <code>size</code> class (0-9).</p>
<p>We wish to find a group mean by <code>sbi x size</code>. However, we demand that the group has at least five records, otherwise we combine the size classes of a single <code>sbi</code> group. This can be done as follows.</p>
<div class="sourceCode" id="first_example"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="first_example-1" title="1"><span class="op">&gt;</span><span class="st"> </span>a &lt;-<span class="st"> </span><span class="kw">accumulate</span>(producers, <span class="dt">collapse =</span> sbi <span class="op">*</span><span class="st"> </span>size <span class="op">~</span><span class="st"> </span></a>
<a class="sourceLine" id="first_example-2" title="2"><span class="op">+</span><span class="st">     </span>sbi, <span class="dt">test =</span> <span class="kw">min_records</span>(<span class="dv">5</span>), <span class="dt">fun =</span> mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="first_example-3" title="3"></a>
<a class="sourceLine" id="first_example-4" title="4"><span class="op">&gt;</span><span class="st"> </span><span class="kw">head</span>(<span class="kw">round</span>(a))</a>
<a class="sourceLine" id="first_example-5" title="5">   sbi size level industrial trade other other_income  total</a>
<a class="sourceLine" id="first_example-6" title="6"><span class="dv">1</span> <span class="dv">3410</span>    <span class="dv">8</span>     <span class="dv">1</span>     <span class="dv">364397</span>  <span class="dv">2859</span>    <span class="dv">33</span>          <span class="dv">353</span> <span class="dv">546117</span></a>
<a class="sourceLine" id="first_example-7" title="7"><span class="dv">2</span> <span class="dv">2840</span>    <span class="dv">7</span>     <span class="dv">0</span>      <span class="dv">23160</span>   <span class="dv">823</span>    <span class="dv">49</span>          <span class="dv">329</span>  <span class="dv">25812</span></a>
<a class="sourceLine" id="first_example-8" title="8"><span class="dv">3</span> <span class="dv">2752</span>    <span class="dv">5</span>    <span class="ot">NA</span>         <span class="ot">NA</span>    <span class="ot">NA</span>    <span class="ot">NA</span>           <span class="ot">NA</span>     <span class="ot">NA</span></a>
<a class="sourceLine" id="first_example-9" title="9"><span class="dv">4</span> <span class="dv">3120</span>    <span class="dv">6</span>     <span class="dv">0</span>      <span class="dv">20710</span>   <span class="dv">504</span>   <span class="dv">112</span>          <span class="dv">200</span>  <span class="dv">21702</span></a>
<a class="sourceLine" id="first_example-10" title="10"><span class="dv">5</span> <span class="dv">2524</span>    <span class="dv">7</span>     <span class="dv">0</span>      <span class="dv">27954</span>  <span class="dv">1268</span>    <span class="dv">55</span>          <span class="dv">456</span>  <span class="dv">30468</span></a>
<a class="sourceLine" id="first_example-11" title="11"><span class="dv">6</span> <span class="dv">3410</span>    <span class="dv">6</span>     <span class="dv">1</span>     <span class="dv">364397</span>  <span class="dv">2859</span>    <span class="dv">33</span>          <span class="dv">353</span> <span class="dv">546117</span></a></code></pre></div>
<p>The accumulate function does the following:</p>
<ul>
<li>For each combination of <code>sbi</code> and <code>size</code> occurring in the data, it checks whether <code>test</code> is satisfied. Here, it tests whether there are at least five records.
<ul>
<li>If the test is satisfied, the mean is computed for each non-grouping variable in the data. The output column <code>level</code> is set to 0 (no collapsing took place).</li>
<li>If the test is <em>not</em> satisfied, it will only use <code>sbi</code> as grouping variable for the current combination of <code>sbi</code> and <code>size</code>. Then, if there are enough records, the mean is computed for each variable and the output variable <code>level</code> is set to 1 (first level of collapsing has been used).</li>
<li>If the test is still not satisfied, no computation is possible and all outputs are <code>NA</code> for the current <code>sbi</code> and <code>size</code> combination.</li>
</ul></li>
</ul>
<p>Explicitly, for this example we see that for <code>(sbi,size)==(2752,5)</code> no satisfactory group of records was found under the current collapsing scheme. Therefore the <code>level</code> variable equals <code>NA</code> and all aggregated variables are missing as well. For <code>(sbi,size)==(22840,7)</code> there are sufficient records, and since <code>level=0</code> no collapsing was necessary. For the group <code>(sbi,size)=(3410,8)</code> there were not enough records to compute a mean, but taking all records in <code>sbi==3410</code> gave enough records. This is signified by <code>level=1</code>, meaning that one collapsing step has taken place (from <code>sbi x size</code> to <code>sbi</code>).</p>
<p>Let us see how we specified this call to <code>accumulate</code></p>
<ul>
<li>The first argument is the data to be aggregated.</li>
<li>The second argument is a formula of the form <code>target groups ~ collapsing scheme</code>. The output is always at the level of the target groups. The collapsing scheme determines which records are used to compute a value for the target groups if the <code>test</code> is not satisfied.</li>
<li>The third argument, called <code>test</code> is a function that should accept any subset of records of <code>producers</code> and return <code>TRUE</code> or <code>FALSE</code>. In this case we used the convenience function <code>min_records(5)</code> provided by <code>accumulate</code>. The function <code>min_records()</code> creates a testing function for us that we can pass as testing function.</li>
<li>Finally, the argument <code>fun</code> is the aggregation function that will be applied to each group.</li>
</ul>
<p>Observe that the accumulate funtion is similar to R’s built-in <code>aggregate</code> function (this is by design). There is a second function called <code>cumulate</code> that has an interface that is similar to <code>dplyr::summarise</code>.</p>
<div class="sourceCode" id="cumulate_formula"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="cumulate_formula-1" title="1"><span class="op">&gt;</span><span class="st"> </span>a &lt;-<span class="st"> </span><span class="kw">cumulate</span>(producers, <span class="dt">collapse =</span> sbi <span class="op">*</span><span class="st"> </span>size <span class="op">~</span><span class="st"> </span>sbi, </a>
<a class="sourceLine" id="cumulate_formula-2" title="2"><span class="op">+</span><span class="st">     </span><span class="dt">test =</span> <span class="cf">function</span>(d) <span class="kw">nrow</span>(d) <span class="op">&gt;=</span><span class="st"> </span><span class="dv">5</span>, <span class="dt">mu_industrial =</span> <span class="kw">mean</span>(industrial, </a>
<a class="sourceLine" id="cumulate_formula-3" title="3"><span class="op">+</span><span class="st">         </span><span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">sd_industrial =</span> <span class="kw">sd</span>(industrial, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cumulate_formula-4" title="4"></a>
<a class="sourceLine" id="cumulate_formula-5" title="5"><span class="op">&gt;</span><span class="st"> </span><span class="kw">head</span>(<span class="kw">round</span>(a))</a>
<a class="sourceLine" id="cumulate_formula-6" title="6">   sbi size level mu_industrial sd_industrial</a>
<a class="sourceLine" id="cumulate_formula-7" title="7"><span class="dv">1</span> <span class="dv">3410</span>    <span class="dv">8</span>     <span class="dv">1</span>        <span class="dv">364397</span>        <span class="dv">535446</span></a>
<a class="sourceLine" id="cumulate_formula-8" title="8"><span class="dv">2</span> <span class="dv">2840</span>    <span class="dv">7</span>     <span class="dv">0</span>         <span class="dv">23160</span>         <span class="dv">13937</span></a>
<a class="sourceLine" id="cumulate_formula-9" title="9"><span class="dv">3</span> <span class="dv">2752</span>    <span class="dv">5</span>    <span class="ot">NA</span>            <span class="ot">NA</span>            <span class="ot">NA</span></a>
<a class="sourceLine" id="cumulate_formula-10" title="10"><span class="dv">4</span> <span class="dv">3120</span>    <span class="dv">6</span>     <span class="dv">0</span>         <span class="dv">20710</span>         <span class="dv">21151</span></a>
<a class="sourceLine" id="cumulate_formula-11" title="11"><span class="dv">5</span> <span class="dv">2524</span>    <span class="dv">7</span>     <span class="dv">0</span>         <span class="dv">27954</span>         <span class="dv">15089</span></a>
<a class="sourceLine" id="cumulate_formula-12" title="12"><span class="dv">6</span> <span class="dv">3410</span>    <span class="dv">6</span>     <span class="dv">1</span>        <span class="dv">364397</span>        <span class="dv">535446</span></a></code></pre></div>
<p>Notice that here, we wrote our own test function.</p>
<h3 id="exercises">Exercises</h3>
<ol type="1">
<li>How many combinations of <code>(sbi, size)</code> could not be computed, even when collapsing to <code>sbi</code>? (You need to run the code and investigate the output).</li>
<li>Compute the trimmed mean of all numeric variables where you trim 5% of each side the distribution. See <code>?mean</code> on how to compute trimmed means.</li>
</ol>
<h2 id="the-formula-interface-for-specifying-collapsing-schemes">The formula interface for specifying collapsing schemes</h2>
<p>A collapsing scheme can be defined in a data frame or with a formula of the form</p>
<pre><code>target grouping ~ collapse1 + collapse2 + ... + collapseN</code></pre>
<p>Here, the <code>target grouping</code> is a variable or product of variables. Each <code>collapse</code> term is also a variable or product of variables. Each subsequent term defines the next collapsing step. Let us show the idea with a more involved example.</p>
<p>The <code>sbi</code> variable in the <code>producers</code> dataset encodes a hierarchical classification where longer digit sequences indicate higher level of detail. Hence we can collapse to lower levels of detail by deleting digits at the end. Let us enrich the <code>producers</code> dataset with extra grouping levels.</p>
<div class="sourceCode" id="derive_sbi_levels"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="derive_sbi_levels-1" title="1"><span class="op">&gt;</span><span class="st"> </span>producers<span class="op">$</span>sbi3 &lt;-<span class="st"> </span><span class="kw">substr</span>(producers<span class="op">$</span>sbi, <span class="dv">1</span>, <span class="dv">3</span>)</a>
<a class="sourceLine" id="derive_sbi_levels-2" title="2"></a>
<a class="sourceLine" id="derive_sbi_levels-3" title="3"><span class="op">&gt;</span><span class="st"> </span>producers<span class="op">$</span>sbi2 &lt;-<span class="st"> </span><span class="kw">substr</span>(producers<span class="op">$</span>sbi, <span class="dv">1</span>, <span class="dv">2</span>)</a>
<a class="sourceLine" id="derive_sbi_levels-4" title="4"></a>
<a class="sourceLine" id="derive_sbi_levels-5" title="5"><span class="op">&gt;</span><span class="st"> </span><span class="kw">head</span>(producers, <span class="dv">3</span>)</a>
<a class="sourceLine" id="derive_sbi_levels-6" title="6">   sbi size industrial trade other other_income  total sbi3 sbi2</a>
<a class="sourceLine" id="derive_sbi_levels-7" title="7"><span class="dv">1</span> <span class="dv">3410</span>    <span class="dv">8</span>     <span class="dv">151722</span>  <span class="dv">2135</span>     <span class="dv">0</span>        <span class="dv">-1775</span> <span class="dv">152082</span>  <span class="dv">341</span>   <span class="dv">34</span></a>
<a class="sourceLine" id="derive_sbi_levels-8" title="8"><span class="dv">2</span> <span class="dv">2840</span>    <span class="dv">7</span>      <span class="dv">50816</span>    <span class="ot">NA</span>   <span class="dv">158</span>          <span class="dv">949</span>  <span class="dv">59876</span>  <span class="dv">284</span>   <span class="dv">28</span></a>
<a class="sourceLine" id="derive_sbi_levels-9" title="9"><span class="dv">3</span> <span class="dv">2752</span>    <span class="dv">5</span>       <span class="dv">4336</span>    <span class="ot">NA</span>     <span class="dv">0</span>           <span class="dv">36</span>   <span class="dv">4959</span>  <span class="dv">275</span>   <span class="dv">27</span></a></code></pre></div>
<p>We can now use a more involved collapsing scheme as follows.</p>
<div class="sourceCode" id="accumulate_formula"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="accumulate_formula-1" title="1"><span class="op">&gt;</span><span class="st"> </span>a &lt;-<span class="st"> </span><span class="kw">accumulate</span>(producers, <span class="dt">collapse =</span> sbi <span class="op">*</span><span class="st"> </span>size <span class="op">~</span><span class="st"> </span></a>
<a class="sourceLine" id="accumulate_formula-2" title="2"><span class="op">+</span><span class="st">     </span>sbi <span class="op">+</span><span class="st"> </span>sbi3 <span class="op">+</span><span class="st"> </span>sbi2, <span class="dt">test =</span> <span class="kw">min_records</span>(<span class="dv">5</span>), <span class="dt">fun =</span> mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="accumulate_formula-3" title="3"></a>
<a class="sourceLine" id="accumulate_formula-4" title="4"><span class="op">&gt;</span><span class="st"> </span><span class="kw">head</span>(<span class="kw">round</span>(a))</a>
<a class="sourceLine" id="accumulate_formula-5" title="5">   sbi size level industrial trade other other_income  total</a>
<a class="sourceLine" id="accumulate_formula-6" title="6"><span class="dv">1</span> <span class="dv">3410</span>    <span class="dv">8</span>     <span class="dv">1</span>     <span class="dv">364397</span>  <span class="dv">2859</span>    <span class="dv">33</span>          <span class="dv">353</span> <span class="dv">546117</span></a>
<a class="sourceLine" id="accumulate_formula-7" title="7"><span class="dv">2</span> <span class="dv">2840</span>    <span class="dv">7</span>     <span class="dv">0</span>      <span class="dv">23160</span>   <span class="dv">823</span>    <span class="dv">49</span>          <span class="dv">329</span>  <span class="dv">25812</span></a>
<a class="sourceLine" id="accumulate_formula-8" title="8"><span class="dv">3</span> <span class="dv">2752</span>    <span class="dv">5</span>     <span class="dv">2</span>      <span class="dv">19526</span>    <span class="dv">39</span>    <span class="dv">52</span>          <span class="dv">151</span>  <span class="dv">20603</span></a>
<a class="sourceLine" id="accumulate_formula-9" title="9"><span class="dv">4</span> <span class="dv">3120</span>    <span class="dv">6</span>     <span class="dv">0</span>      <span class="dv">20710</span>   <span class="dv">504</span>   <span class="dv">112</span>          <span class="dv">200</span>  <span class="dv">21702</span></a>
<a class="sourceLine" id="accumulate_formula-10" title="10"><span class="dv">5</span> <span class="dv">2524</span>    <span class="dv">7</span>     <span class="dv">0</span>      <span class="dv">27954</span>  <span class="dv">1268</span>    <span class="dv">55</span>          <span class="dv">456</span>  <span class="dv">30468</span></a>
<a class="sourceLine" id="accumulate_formula-11" title="11"><span class="dv">6</span> <span class="dv">3410</span>    <span class="dv">6</span>     <span class="dv">1</span>     <span class="dv">364397</span>  <span class="dv">2859</span>    <span class="dv">33</span>          <span class="dv">353</span> <span class="dv">546117</span></a></code></pre></div>
<p>Observe that for <code>(sbi,size) == (3410,8)</code> we have 3 levels of collapsing. In other words, for that aggregate, all records in <code>sbi2 == 34</code> were used.</p>
<h3 id="exercises-1">Exercises</h3>
<ol type="1">
<li>Compute standard deviation for <code>trade</code> and <code>total</code> using the <code>cumulate</code> function under the same collapsing scheme as defined above.</li>
<li>What is the maximum collapsing level in the collapsing scheme above?</li>
<li>Find out how many combinations of <code>(sbi,size)</code> have been collapsed to level 0, 1, 2, or 3. Tabulate them.</li>
<li>Define a collapsing scheme that ends with a single-digit <code>sbi</code> code and compute the means of all variables.</li>
</ol>
<h2 id="the-data-frame-interface-for-defining-collapsing-schemes">The data frame interface for defining collapsing schemes</h2>
<p>Collapsing schemes can be represented in data frames that have the form</p>
<pre><code>[target group, parent of target group, parent of parent of target group,...].</code></pre>
<p>The package comes with a helper function that creates such a scheme from hierarchical classifications that are encoded as digits.</p>
<p>For the <code>sbi</code> example we can do the following to derive a collapsing scheme.</p>
<div class="sourceCode" id="dataframe_construction"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="dataframe_construction-1" title="1"><span class="op">&gt;</span><span class="st"> </span>sbi &lt;-<span class="st"> </span><span class="kw">unique</span>(producers<span class="op">$</span>sbi)</a>
<a class="sourceLine" id="dataframe_construction-2" title="2"></a>
<a class="sourceLine" id="dataframe_construction-3" title="3"><span class="op">&gt;</span><span class="st"> </span>csh &lt;-<span class="st"> </span><span class="kw">csh_from_digits</span>(sbi)</a>
<a class="sourceLine" id="dataframe_construction-4" title="4"></a>
<a class="sourceLine" id="dataframe_construction-5" title="5"><span class="op">&gt;</span><span class="st"> </span><span class="kw">names</span>(csh)[<span class="dv">1</span>] &lt;-<span class="st"> &quot;sbi&quot;</span></a>
<a class="sourceLine" id="dataframe_construction-6" title="6"></a>
<a class="sourceLine" id="dataframe_construction-7" title="7"><span class="op">&gt;</span><span class="st"> </span><span class="kw">head</span>(csh)</a>
<a class="sourceLine" id="dataframe_construction-8" title="8">   sbi   A1  A2 A3 A4</a>
<a class="sourceLine" id="dataframe_construction-9" title="9"><span class="dv">1</span> <span class="dv">3410</span> <span class="dv">3410</span> <span class="dv">341</span> <span class="dv">34</span>  <span class="dv">3</span></a>
<a class="sourceLine" id="dataframe_construction-10" title="10"><span class="dv">2</span> <span class="dv">2840</span> <span class="dv">2840</span> <span class="dv">284</span> <span class="dv">28</span>  <span class="dv">2</span></a>
<a class="sourceLine" id="dataframe_construction-11" title="11"><span class="dv">3</span> <span class="dv">2752</span> <span class="dv">2752</span> <span class="dv">275</span> <span class="dv">27</span>  <span class="dv">2</span></a>
<a class="sourceLine" id="dataframe_construction-12" title="12"><span class="dv">4</span> <span class="dv">3120</span> <span class="dv">3120</span> <span class="dv">312</span> <span class="dv">31</span>  <span class="dv">3</span></a>
<a class="sourceLine" id="dataframe_construction-13" title="13"><span class="dv">5</span> <span class="dv">2524</span> <span class="dv">2524</span> <span class="dv">252</span> <span class="dv">25</span>  <span class="dv">2</span></a>
<a class="sourceLine" id="dataframe_construction-14" title="14"><span class="dv">6</span> <span class="dv">2875</span> <span class="dv">2875</span> <span class="dv">287</span> <span class="dv">28</span>  <span class="dv">2</span></a></code></pre></div>
<p>Here, the column <code>sbi</code> denotes the original (maximally) 5-digit codes, <code>A1</code> the 4-digit codes, and so on. It is important that the name of the first column matches a column in the data to be agregated. Both <code>cumlate</code> and <code>accumulate</code> accept such a data frame as an argument. Here is an example with <code>cumulate</code>.</p>
<div class="sourceCode" id="dataframe_cumulate"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="dataframe_cumulate-1" title="1"><span class="op">&gt;</span><span class="st"> </span>a &lt;-<span class="st"> </span><span class="kw">cumulate</span>(producers, <span class="dt">collapse =</span> csh, <span class="dt">test =</span> <span class="cf">function</span>(d) <span class="kw">nrow</span>(d) <span class="op">&gt;=</span><span class="st"> </span></a>
<a class="sourceLine" id="dataframe_cumulate-2" title="2"><span class="op">+</span><span class="st">     </span><span class="dv">5</span>, <span class="dt">mu_total =</span> <span class="kw">mean</span>(total, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">sd_total =</span> <span class="kw">sd</span>(total, </a>
<a class="sourceLine" id="dataframe_cumulate-3" title="3"><span class="op">+</span><span class="st">     </span><span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="dataframe_cumulate-4" title="4"></a>
<a class="sourceLine" id="dataframe_cumulate-5" title="5"><span class="op">&gt;</span><span class="st"> </span><span class="kw">head</span>(a)</a>
<a class="sourceLine" id="dataframe_cumulate-6" title="6">   sbi level  mu_total  sd_total</a>
<a class="sourceLine" id="dataframe_cumulate-7" title="7"><span class="dv">1</span> <span class="dv">3410</span>     <span class="dv">0</span> <span class="fl">546117.22</span> <span class="fl">844001.47</span></a>
<a class="sourceLine" id="dataframe_cumulate-8" title="8"><span class="dv">2</span> <span class="dv">2840</span>     <span class="dv">0</span>  <span class="fl">31265.28</span>  <span class="fl">35053.37</span></a>
<a class="sourceLine" id="dataframe_cumulate-9" title="9"><span class="dv">3</span> <span class="dv">2752</span>     <span class="dv">2</span>  <span class="fl">20603.08</span>  <span class="fl">31286.51</span></a>
<a class="sourceLine" id="dataframe_cumulate-10" title="10"><span class="dv">4</span> <span class="dv">3120</span>     <span class="dv">0</span>  <span class="fl">26548.61</span>  <span class="fl">26784.60</span></a>
<a class="sourceLine" id="dataframe_cumulate-11" title="11"><span class="dv">5</span> <span class="dv">2524</span>     <span class="dv">0</span>  <span class="fl">23434.68</span>  <span class="fl">18022.32</span></a>
<a class="sourceLine" id="dataframe_cumulate-12" title="12"><span class="dv">7</span> <span class="dv">2875</span>     <span class="dv">0</span>  <span class="fl">15962.24</span>   <span class="fl">9640.14</span></a></code></pre></div>
<p>In this representation is is not possible to use multiple grouping variables, unless you combine multiple grouping variables into a single one, for example by pasting them together.</p>
<p>The advantage of this representation is that it allows users to externally define a (manually edited) collapsing scheme.</p>
<h3 id="exercises-2">Exercises</h3>
<ol type="1">
<li>Use <code>csh</code> to compute the median of all numerical variables of the <code>producers</code> dataset with <code>accumulate</code> (hint: you need to remove the <code>size</code> variable).</li>
</ol>
<h2 id="convenience-functions-to-define-tests">Convenience functions to define tests</h2>
<p>There are several options to define test on groups of records:</p>
<ol type="1">
<li>Use one of the built-in functions to specify common test conditions: <code>min_records()</code>, <code>min_complete()</code>, or <code>frac_complete()</code>.</li>
<li>Use a ruleset defined with the <a href="https://cran.r-project.org/package=validate">validate</a> package, with the <code>from_validator()</code> function.</li>
<li>Write your own custom test function.</li>
</ol>
<p>Let us look at a small example for each case. For comparison we will always test that there are a minimum of five records.</p>
<div class="sourceCode" id="helpers"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="helpers-1" title="1"><span class="op">&gt;</span><span class="st"> </span><span class="kw">data</span>(producers)</a>
<a class="sourceLine" id="helpers-2" title="2"></a>
<a class="sourceLine" id="helpers-3" title="3"><span class="op">&gt;</span><span class="st"> </span>a &lt;-<span class="st"> </span><span class="kw">accumulate</span>(producers, <span class="dt">collapse =</span> sbi <span class="op">*</span><span class="st"> </span>size <span class="op">~</span><span class="st"> </span></a>
<a class="sourceLine" id="helpers-4" title="4"><span class="op">+</span><span class="st">     </span>sbi, <span class="dt">test =</span> <span class="kw">min_records</span>(<span class="dv">5</span>), <span class="dt">fun =</span> mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="helpers-5" title="5"></a>
<a class="sourceLine" id="helpers-6" title="6"><span class="op">&gt;</span><span class="st"> </span>rules &lt;-<span class="st"> </span>validate<span class="op">::</span><span class="kw">validator</span>(<span class="kw">nrow</span>(.) <span class="op">&gt;=</span><span class="st"> </span><span class="dv">3</span>)</a>
<a class="sourceLine" id="helpers-7" title="7"></a>
<a class="sourceLine" id="helpers-8" title="8"><span class="op">&gt;</span><span class="st"> </span>a &lt;-<span class="st"> </span><span class="kw">accumulate</span>(producers, <span class="dt">collapse =</span> sbi <span class="op">*</span><span class="st"> </span>size <span class="op">~</span><span class="st"> </span></a>
<a class="sourceLine" id="helpers-9" title="9"><span class="op">+</span><span class="st">     </span>sbi, <span class="dt">test =</span> <span class="kw">from_validator</span>(rules), <span class="dt">fun =</span> mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="helpers-10" title="10"></a>
<a class="sourceLine" id="helpers-11" title="11"><span class="op">&gt;</span><span class="st"> </span>a &lt;-<span class="st"> </span><span class="kw">accumulate</span>(producers, <span class="dt">collapse =</span> sbi <span class="op">*</span><span class="st"> </span>size <span class="op">~</span><span class="st"> </span></a>
<a class="sourceLine" id="helpers-12" title="12"><span class="op">+</span><span class="st">     </span>sbi, <span class="dt">test =</span> <span class="cf">function</span>(d) <span class="kw">nrow</span>(d) <span class="op">&gt;=</span><span class="st"> </span><span class="dv">5</span>, <span class="dt">fun =</span> mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<h3 id="smoke-testing-your-test-function">Smoke-testing your test function</h3>
<p>If you write your own test function from scratch, it is easy to overlook some edge cases like the occurrence of missing data, a column that is completely <code>NA</code>, or receiving zero records. The function <code>smoke_test()</code> accepts a data set and a test function and runs the test function on several common edge cases based on the dataset. It does <em>not</em> check whether the test function works as expected, but it checks that the output is <code>TRUE</code> or <code>FALSE</code> in all cases and reports errors, warnings and mesages if they occur.</p>
<p>As an example we construct a test function that checks whether one of the variables has sufficient non-zero values.</p>
<div class="sourceCode" id="smoketest1"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="smoketest1-1" title="1"><span class="op">&gt;</span><span class="st"> </span>my_test &lt;-<span class="st"> </span><span class="cf">function</span>(d) <span class="kw">sum</span>(other <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="smoketest1-2" title="2"></a>
<a class="sourceLine" id="smoketest1-3" title="3"><span class="op">&gt;</span><span class="st"> </span><span class="kw">smoke_test</span>(producers, my_test)</a>
<a class="sourceLine" id="smoketest1-4" title="4"></a>
<a class="sourceLine" id="smoketest1-5" title="5">Test with full dataset raised issues.</a>
<a class="sourceLine" id="smoketest1-6" title="6">   ERR<span class="op">:</span><span class="st"> </span>object <span class="st">&#39;other&#39;</span> not found</a></code></pre></div>
<p>Oops, we forgot to refer to the data set. Let’s try it again.</p>
<div class="sourceCode" id="smoketest2"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="smoketest2-1" title="1"><span class="op">&gt;</span><span class="st"> </span>my_test &lt;-<span class="st"> </span><span class="cf">function</span>(d) <span class="kw">sum</span>(d<span class="op">$</span>other <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="smoketest2-2" title="2"></a>
<a class="sourceLine" id="smoketest2-3" title="3"><span class="op">&gt;</span><span class="st"> </span><span class="kw">smoke_test</span>(producers, my_test)</a>
<a class="sourceLine" id="smoketest2-4" title="4"></a>
<a class="sourceLine" id="smoketest2-5" title="5">Test with full dataset raised issues.</a>
<a class="sourceLine" id="smoketest2-6" title="6">   <span class="ot">NA</span> detected <span class="cf">in</span> <span class="kw">output</span> (must be <span class="ot">TRUE</span> or <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="smoketest2-7" title="7">Test with first record and other is <span class="ot">NA</span> raised issues.</a>
<a class="sourceLine" id="smoketest2-8" title="8">   <span class="ot">NA</span> detected <span class="cf">in</span> <span class="kw">output</span> (must be <span class="ot">TRUE</span> or <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="smoketest2-9" title="9">Test with first record and all values <span class="ot">NA</span> raised issues.</a>
<a class="sourceLine" id="smoketest2-10" title="10">   <span class="ot">NA</span> detected <span class="cf">in</span> <span class="kw">output</span> (must be <span class="ot">TRUE</span> or <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="smoketest2-11" title="11">Test with full dataset and sbi is <span class="ot">NA</span> <span class="cf">for</span> all records raised issues.</a>
<a class="sourceLine" id="smoketest2-12" title="12">   <span class="ot">NA</span> detected <span class="cf">in</span> <span class="kw">output</span> (must be <span class="ot">TRUE</span> or <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="smoketest2-13" title="13">Test with full dataset and size is <span class="ot">NA</span> <span class="cf">for</span> all records raised issues.</a>
<a class="sourceLine" id="smoketest2-14" title="14">   <span class="ot">NA</span> detected <span class="cf">in</span> <span class="kw">output</span> (must be <span class="ot">TRUE</span> or <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="smoketest2-15" title="15">Test with full dataset and industrial is <span class="ot">NA</span> <span class="cf">for</span> all records raised issues.</a>
<a class="sourceLine" id="smoketest2-16" title="16">   <span class="ot">NA</span> detected <span class="cf">in</span> <span class="kw">output</span> (must be <span class="ot">TRUE</span> or <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="smoketest2-17" title="17">Test with full dataset and trade is <span class="ot">NA</span> <span class="cf">for</span> all records raised issues.</a>
<a class="sourceLine" id="smoketest2-18" title="18">   <span class="ot">NA</span> detected <span class="cf">in</span> <span class="kw">output</span> (must be <span class="ot">TRUE</span> or <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="smoketest2-19" title="19">Test with full dataset and other is <span class="ot">NA</span> <span class="cf">for</span> all records raised issues.</a>
<a class="sourceLine" id="smoketest2-20" title="20">   <span class="ot">NA</span> detected <span class="cf">in</span> <span class="kw">output</span> (must be <span class="ot">TRUE</span> or <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="smoketest2-21" title="21">Test with full dataset and other_income is <span class="ot">NA</span> <span class="cf">for</span> all records raised issues.</a>
<a class="sourceLine" id="smoketest2-22" title="22">   <span class="ot">NA</span> detected <span class="cf">in</span> <span class="kw">output</span> (must be <span class="ot">TRUE</span> or <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="smoketest2-23" title="23">Test with full dataset and total is <span class="ot">NA</span> <span class="cf">for</span> all records raised issues.</a>
<a class="sourceLine" id="smoketest2-24" title="24">   <span class="ot">NA</span> detected <span class="cf">in</span> <span class="kw">output</span> (must be <span class="ot">TRUE</span> or <span class="ot">FALSE</span>)</a></code></pre></div>
<p>Our function is not robust against occurrence of <code>NA</code>. Here’s a third attempt.</p>
<div class="sourceCode" id="smoketest3"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="smoketest3-1" title="1"><span class="op">&gt;</span><span class="st"> </span>my_test &lt;-<span class="st"> </span><span class="cf">function</span>(d) <span class="kw">sum</span>(d<span class="op">$</span>other <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">&gt;</span><span class="st"> </span></a>
<a class="sourceLine" id="smoketest3-2" title="2"><span class="op">+</span><span class="st">     </span><span class="dv">3</span></a>
<a class="sourceLine" id="smoketest3-3" title="3"></a>
<a class="sourceLine" id="smoketest3-4" title="4"><span class="op">&gt;</span><span class="st"> </span><span class="kw">smoke_test</span>(producers, my_test)</a></code></pre></div>
<h3 id="exercises-3">Exercises</h3>
<ol type="1">
<li>Compute the mean of all variables using <code>sbi*size ~ sbi1 + sbi2</code> as collapsing scheme. Make sure there are at least 10 records in each group.</li>
<li>Compute the mean of the ratio between <code>industrial</code> and <code>total</code>, but demand that there are not more than 20% zeros in <code>other</code>. Use <code>csh</code> as collapsing scheme.</li>
</ol>
</body>
</html>
